### Java JVM <!-- {docsify-ignore} -->

**æ–‡æ¡£æ›´æ–°æ—¥æœŸ: {docsify-updated}**

---

#### 1.JVM ç»“æ„

JVMï¼ˆhotspotï¼‰ç»“æ„æ¦‚è§ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/agTr0m.png)

ä¸Šå›¾ä¸­ï¼Œç°è‰²éƒ¨åˆ†ï¼ˆJava æ ˆï¼Œæœ¬åœ°æ–¹æ³•æ ˆå’Œç¨‹åºè®¡æ•°å™¨ï¼‰æ˜¯çº¿ç¨‹ç§æœ‰ï¼Œä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œæ©™è‰²éƒ¨åˆ†ï¼ˆæ–¹æ³•åŒºå’Œå †ï¼‰ä¸ºçº¿ç¨‹å…±äº«åŒºã€‚

#### 2.ç±»åŠ è½½å™¨

**ç±»åŠ è½½å™¨**(Class Loader)è´Ÿè´£åŠ è½½ class æ–‡ä»¶ï¼Œclass æ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ ‡è¯†ã€‚

ç±»åŠ è½½å™¨å°† class æ–‡ä»¶å­—èŠ‚ç å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°†è¿™äº›å†…å®¹è½¬æ¢æˆ**æ–¹æ³•åŒº**ä¸­çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚

ClassLoader åªè´Ÿè´£ class æ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”±æ‰§è¡Œå¼•æ“ Execution Engine å†³å®šã€‚

ç±»åŠ è½½ç¤ºæ„å›¾ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/8u3DGN.png)

ç±»åŠ è½½å™¨è¯†åˆ«çš„ class æ–‡ä»¶é™¤äº†æ˜¯**.class**æ ¼å¼å¤–ï¼Œæ–‡ä»¶çš„å¼€å¤´è¿˜å¾—æœ‰ç‰¹æ®Šçš„æ ‡è¯†ï¼Œä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ä¸€ä¸ª class æ ¼å¼çš„æ–‡ä»¶ï¼š

```
cafe babe 0000 0034 0010 0a00 0300 0d07
000e 0700 0f01 0006 3c69 6e69 743e 0100
0328 2956 0100 0443 6f64 6501 000f 4c69
6e65 4e75 6d62 6572 5461 626c 6501 0012
4c6f 6361 6c56 6172 6961 626c 6554 6162
6c65 0100 0474 6869 7301 0014 4c63 632f
6d72 6269 7264 2f63 6173 2f54 6573 743b
0100 0a53 6f75 7263 6546 696c 6501 0009
5465 7374 2e6a 6176 610c 0004 0005 0100
1263 632f 6d72 6269 7264 2f63 6173 2f54
6573 7401 0010 6a61 7661 2f6c 616e 672f
4f62 6a65 6374 0021 0002 0003 0000 0000
0001 0001 0004 0005 0001 0006 0000 002f
0001 0001 0000 0005 2ab7 0001 b100 0000
0200 0700 0000 0600 0100 0000 0300 0800
0000 0c00 0100 0000 0500 0900 0a00 0000
0100 0b00 0000 0200 0c
```

è¿™ä¸ªç‰¹å®šçš„æ ‡è¯†å°±æ˜¯åå…­è¿›åˆ¶å­—ç¬¦**cafe babe**ã€‚

##### 2.1.ç±»åŠ è½½å™¨åˆ†ç±»

?> ç±»åŠ è½½å™¨åˆ†ä¸º 4 ç§ï¼š

<!-- tabs:start -->

##### **å¯åŠ¨ç±»åŠ è½½å™¨**

å¯åŠ¨ç±»åŠ è½½å™¨ BootstrapClassLoader ä¹Ÿå«æ ¹åŠ è½½å™¨ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨ï¼Œåº•å±‚ç”± C++å®ç°ï¼Œç”¨äºåŠ è½½`$JAVA_HOME/jre/lib/rt.jar`åŒ…å†…çš„ class æ–‡ä»¶ã€‚

?> rt.jar æ˜¯ Java åŸºç¡€ç±»åº“ï¼ŒåŒ…å« Java è¿è¡Œç¯å¢ƒæ‰€éœ€çš„åŸºç¡€ç±»

##### **æ‹“å±•ç±»åŠ è½½å™¨**

æ‹“å±•ç±»åŠ è½½å™¨ ExtClassLoader æ˜¯è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨ï¼Œç”± Java è¯­è¨€å®ç°ï¼Œç”¨äºåŠ è½½$JAVA_HOME/jre/lib/ext/\*\*.jar ç›®å½•ä¸‹çš„ class æ–‡ä»¶ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/BvDI7d.png)

?> è¿™éƒ¨åˆ†ä¸»è¦æ˜¯ Java åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œä¸€äº›æ‹“å±•çš„åŠŸèƒ½ã€‚

```java
public class Test {
    public static void main(String[] args) {
        ZipInfo zipInfo = new ZipInfo();
        System.out.println(zipInfo.getClass().getClassLoader());
    }
}
```

`ZipInfo`æ˜¯`$JAVA_HOME/jre/lib/ext/zipfs.jar`åŒ…é‡Œçš„ä¸€ä¸ªç±»ï¼Œç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```
sun.misc.Launcher$ExtClassLoader@5e2de80c
```

##### **åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨**

åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ AppClassLoader æ˜¯è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½å½“å‰åº”ç”¨çš„ classpath çš„æ‰€æœ‰ç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„é‚£äº› Java ä»£ç 

```java
public class Test {
    public static void main(String[] args) {
        System.out.println(Test.class.getClassLoader());
    }
}
```

ç¨‹åºè¿è¡Œç»“æœï¼š

```
sun.misc.Launcher$AppClassLoader@18b4aac2
```

##### **ç”¨æˆ·è‡ªå®šä¹‰åŠ è½½å™¨**

é™¤äº†ä½¿ç”¨ä¸Šé¢ä¸‰ç§ JVM è‡ªå¸¦çš„ç±»åŠ è½½å™¨å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿ Java.lang.ClassLoader æŠ½è±¡ç±»è‡ªå®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨ã€‚

**è¿™å››ç§ç±»åŠ è½½å™¨çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º**ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/Uh4yr6.png)

å®ƒä»¬çš„å…³ç³»æ˜¯ä¸€ç§çˆ¶å­å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»£ç éªŒè¯ï¼š

```java
public class Test {
    public static void main(String[] args) {
        Class<Test> testClass = Test.class;
        System.out.println(testClass.getClassLoader());
        System.out.println(testClass.getClassLoader().getParent());
        System.out.println(testClass.getClassLoader().getParent().getParent());
    }
}
```

ç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
sun.misc.Launcher$AppClassLoader@18b4aac2
sun.misc.Launcher$ExtClassLoader@61bbe9ba
null
```

<!-- tabs:end -->

##### 2.2.ç±»åŠ è½½æ­¥éª¤

?> ç±»çš„åŠ è½½è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

<!-- tabs:start -->

##### **åŠ è½½ Loading**

é€šè¿‡ä¸€ä¸ªç±»çš„å…¨ç±»åè·å–å…¶äºŒè¿›åˆ¶å­—èŠ‚æµï¼Œå°†è¿™ä¸ªäºŒè¿›åˆ¶æµä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œç„¶ååœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„ java.lang.Class å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºä¸­è¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚

##### **é“¾æ¥ Linking**

?> è¯¥è¿‡ç¨‹åˆå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š**éªŒè¯ Verfication**ï¼Œ**å‡†å¤‡ Preparation**å’Œ**è§£æ Resolution**ï¼‰ã€‚

- éªŒè¯é˜¶æ®µç”¨äºç¡®ä¿åŠ è½½çš„ Class æ–‡ä»¶çš„å­—èŠ‚æµåŒ…å«çš„ä¿¡æ¯æ˜¯å¦ç¬¦åˆè™šæ‹Ÿæœºè¦æ±‚ï¼Œä¿è¯å…¶æ­£ç¡®æ€§åˆæ³•æ€§ï¼›
- å‡†å¤‡é˜¶æ®µä¸ºç±»å˜é‡ï¼ˆstatic ä¿®é¥°çš„å˜é‡ï¼‰åˆ†é…å†…å­˜å¹¶æ ¹æ®å¯¹è±¡ç±»å‹è®¾ç½®ç›¸åº”çš„é»˜è®¤åˆå§‹å€¼ï¼ˆæ¯”å¦‚ int ç±»å‹ä¸º 0ï¼ŒInteger ç±»å‹ä¸º nullï¼‰ã€‚ è¿™é‡Œä¸åŒ…å«å¸¸é‡ï¼Œå› ä¸ºå¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™åˆ†é…ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾ç¤ºåˆå§‹åŒ–ã€‚ ç±»çš„å®ä¾‹å˜é‡ä¸ä¼šåœ¨è¿™ä¸ªé˜¶æ®µå‡†å¤‡åˆå§‹åŒ–ã€‚
- è§£æé˜¶æ®µç”¨äºå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚

```java
public class Test {
    public static void main(String[] args) {
        String str = "hello";
        System.out.println(str);
    }
}
```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/3AuDFk.png)

?> è§£æé˜¶æ®µå°±æ˜¯å°†å…¶è§£æä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚

##### **åˆå§‹åŒ– Initialization**

1. **è¯¥é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»çš„æ„é€ å™¨æ–¹æ³•<clinit>()çš„è¿‡ç¨‹**

è¯¥æ–¹æ³•å¹¶ä¸æ˜¯ç±»çš„æ„é€ å™¨ï¼Œä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å®šä¹‰ï¼Œæ˜¯ javac ç¼–è¯‘å™¨è‡ªåŠ¨æœé›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ï¼›

```java
package com.xujiajun.loader;

public class Test2 {
    private static int aaa = 1;
    static {
        aaa = 200;
    }
    public static void main(String[] args) {
        System.out.println(aaa);
    }
}

```

ç„¶åé€šè¿‡ IDEA çš„ jclasslib æ’ä»¶æŸ¥çœ‹è¯¥ç±»çš„ class æ–‡ä»¶å¯¹åº”çš„å­—èŠ‚ç ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/j7iVHe.png)

å¯ä»¥çœ‹åˆ°ä¸Šé¢æ‰€è¯´çš„æ„é€ å™¨æ–¹æ³•<clinit>()ï¼ŒæŒ‡ä»¤çš„æ“ä½œå°±æ˜¯ä¸ºæ‰€æœ‰ç±»å˜é‡èµ‹å€¼ä»¥åŠé™æ€ä»£ç å—ä¸­çš„æ“ä½œã€‚

!> æ¢å¥è¯è¯´ï¼Œå¦‚æœä¸€ä¸ªç±»ä¸åŒ…å«ç±»å˜é‡å’Œé™æ€ä»£ç å—ï¼Œé‚£ä¹ˆå®ƒçš„å­—èŠ‚ç ä¸­å°±ä¸ä¼šæœ‰æ„é€ å™¨æ–¹æ³•<clinit>()

2. **æ„é€ å™¨æ–¹æ³•ä¸­çš„æŒ‡ä»¤æŒ‰ç…§è¯­å¥åœ¨æºä»£ç ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œ**

```java
package com.xujiajun.loader;

public class Test2 {
    private static int aaa = 1;
    static {
        aaa = 200;
        bbb = 300;
    }

    private static int bbb = 3;

    public static void main(String[] args) {
        System.out.println(bbb);
    }
}

```

ä¸Šé¢ç¨‹åºè¾“å‡ºç»“æœä¸º 2ï¼Œå› ä¸ºæ„é€ å™¨æ–¹æ³•ä¸­çš„æŒ‡ä»¤æŒ‰ç…§è¯­å¥åœ¨æºä»£ç ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œï¼ŒæŸ¥çœ‹æ„é€ å™¨æ–¹æ³•<clinit>()æŒ‡ä»¤æ¥è¯æ˜è¿™ä¸€ç‚¹ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/bsy4Sr.png)

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨é™æ€ä»£ç å—ä¸‹é¢æ‰å®šä¹‰çš„ç±»å˜é‡ bbbï¼Œåœ¨é™æ€ä»£ç å—ä¸­å¯ä»¥è¿›è¡Œä¿®æ”¹å‘¢ï¼Ÿ

è¿™å°±æ˜¯ Linking é˜¶æ®µä¸­å‡†å¤‡é˜¶æ®µæ‰€åšçš„äº‹æƒ…ï¼Œå‡†å¤‡é˜¶æ®µä¸ºç±»å˜é‡ï¼ˆstatic ä¿®é¥°çš„å˜é‡ï¼‰åˆ†é…å†…å­˜å¹¶æ ¹æ®å¯¹è±¡ç±»å‹è®¾ç½®ç›¸åº”çš„é»˜è®¤åˆå§‹å€¼ã€‚

è¿™ä¸ªæ—¶å€™ bbb å·²ç»è¢«åˆ†é…å¹¶èµ‹äºˆé»˜è®¤åˆå§‹å€¼äº†ï¼Œæ‰€ä»¥ static å—ä¸­å¯ä»¥ä½¿ç”¨è¯¥å˜é‡ï¼ˆæ¢å¥è¯è¯´ï¼Œå®ä¾‹å˜é‡ä¸è¡Œï¼‰ã€‚

3. **è‹¥è¯¥ç±»åŒ…å«çˆ¶ç±»ï¼Œé‚£ä¹ˆ JVM ä¼šä¿è¯çˆ¶ç±»çš„<clinit>()å…ˆæ‰§è¡Œå®Œæ¯•**
4. **è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„<clinit>()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”**

```java
public class Test {

    public static void main(String[] args) {
        Runnable r = () -> {
            System.out.println(Thread.currentThread().getName() + "å¼€å§‹");
            new Hello();
            System.out.println(Thread.currentThread().getName() + "ç»“æŸ");
        };
        new Thread(r, "çº¿ç¨‹1").start();
        new Thread(r, "çº¿ç¨‹2").start();
    }
}

class Hello {
    static {
        if (true) {
            System.out.println(Thread.currentThread().getName() + "åˆå§‹åŒ–å½“å‰ç±»");
            while (true) {
            }
        }
    }
}
```

ç¨‹åºå¯åŠ¨åï¼Œmain çº¿ç¨‹å¯åŠ¨ä¸¤ä¸ªå­çº¿ç¨‹ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

```
çº¿ç¨‹1å¼€å§‹
çº¿ç¨‹2å¼€å§‹
çº¿ç¨‹1åˆå§‹åŒ–å½“å‰ç±»
```

ç„¶åç¨‹åº block ä½ï¼Œè¿™è¯´æ˜äº†è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„`<clinit>()`æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ã€‚

<!-- tabs:end -->

##### 2.3.åŒäº²å§”æ´¾æœºåˆ¶

èŠåˆ°ç±»åŠ è½½å™¨ä¸å¾—ä¸æçš„å¦ä¸€ä¸ªè¯é¢˜å°±æ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼Œåœ¨äº†è§£ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸ªä¾‹å­ï¼š

åœ¨ src/main/java ç›®å½•ä¸‹æ–°å»º java.lang åŒ…ï¼Œç„¶ååœ¨è¯¥åŒ…ä¸‹æ–°å»ºä¸€ä¸ª String ç±»ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/e3vlVX.png)

String ç±»çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
package java.lang;

public class String {
    public static void main(String[] args) {
        System.out.println("helo");
    }
}
```

ç¨‹åºè¾“å‡ºç»“æœï¼š

```shell
é”™è¯¯: åœ¨ç±» java.lang.String ä¸­æ‰¾ä¸åˆ° main æ–¹æ³•, è¯·å°† main æ–¹æ³•å®šä¹‰ä¸º:
   public static void main(String[] args)
å¦åˆ™ JavaFX åº”ç”¨ç¨‹åºç±»å¿…é¡»æ‰©å±•javafx.application.Application
```

?> æ‰€è°“çš„åŒäº²å§”æ´¾æœºåˆ¶å°±æ˜¯ï¼šå½“ä¸€ä¸ªç±»æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œä»–é¦–å…ˆä¸ä¼šå°è¯•è‡ªå·±å»åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ã€‚åªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ˆåœ¨å®ƒçš„åŠ è½½è·¯å¾„ä¸‹æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€åŠ è½½çš„ Classï¼‰ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚

æ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAppClassLoader å§”æ´¾ç»™å®ƒçš„çˆ¶ç±» ExtClassLoader å»åŠ è½½ï¼ŒExtClassLoader åˆå§”æ‰˜ç»™å®ƒçš„çˆ¶ç±» BootstrapClassLoader å»åŠ è½½ã€‚BootstrapClassLoader ä»å®ƒçš„åŠ è½½è·¯å¾„`$JAVA_HOME/jre/lib/rt.jar`ä¸‹æ‰¾åˆ°äº†`java.lang.String`ç±»ï¼Œå³ rt.jar åŒ…ä¸‹çš„ String ç±»ï¼Œè€Œè¯¥ç±»é‡Œå¹¶æ²¡æœ‰ main æ–¹æ³•ï¼Œæ‰€ä»¥ä¾¿æŠ›å‡ºäº†å¦‚ä¸Šå¼‚å¸¸ã€‚

?> é‡‡ç”¨åŒäº²å§”æ´¾çš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼šå°±å¦‚ä¸Šé¢æ‰€è¯´ï¼Œä¸ç®¡æ˜¯å“ªä¸ªåŠ è½½å™¨åŠ è½½è¿™ä¸ªç±»ï¼Œæœ€ç»ˆéƒ½æ˜¯å§”æ‰˜ç»™é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œè¿™æ ·å°±ä¿è¯äº†ä½¿ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨æœ€ç»ˆå¾—åˆ°çš„éƒ½æ˜¯åŒæ ·ä¸€ä¸ª String å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ Java ç±»å¹¶ä¸ä¼šæ±¡æŸ“ JDK è‡ªå¸¦çš„é‚£äº›ç±»ï¼ˆå³ä½¿å…¨ç±»åä¸€æ ·ï¼‰ï¼Œè¿™ç§ä¿æŠ¤æœºåˆ¶ä¹Ÿå«**æ²™ç®±å®‰å…¨æœºåˆ¶**ã€‚

#### 3.ç¨‹åºè®¡æ•°å™¨

ç¨‹åºè®¡æ•°å™¨(Program Counter Register)åˆå« PC å¯„å­˜å™¨ã€‚

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

å®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•åŒºä¸­çš„æ–¹æ³•å­—èŠ‚ç ï¼Œç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ï¼Œç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®°ã€‚

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/YNhGMA.png)

?> å¦‚æœæ‰§è¡Œçš„æ˜¯ä¸€ä¸ª Native æ–¹æ³•ï¼Œé‚£è¿™ä¸ªè®¡æ•°å™¨çš„å€¼ä¸º undefiedã€‚

?> ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºè®¡æ•°å™¨å‘¢ï¼Ÿå› ä¸º CPU éœ€è¦ä¸åœåœ°åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œæœ‰äº†ç¨‹åºè®¡æ•°å™¨åï¼Œå½“ CPU åˆ‡æ¢å›æ¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“æ¥ç€ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œç¨‹åº

```java
package com.xujiajun.count;

public class Test {
    public static void main(String[] args) {
        int a = 1;
        int b = 2;
        int c = a + b;
        System.out.println(c);
    }
}

```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/8XIe1k.png)

å‡å¦‚å½“å‰çº¿ç¨‹çš„ç¨‹åºè®¡æ•°å™¨å­˜å‚¨çš„æŒ‡ä»¤åœ°å€ä¸º 6ï¼Œè¿™æ—¶å€™ CPU åˆ‡æ¢åˆ°åˆ«çš„çº¿ç¨‹ä¸­å¤„ç†å·¥ä½œï¼›ä¸€æ®µæ—¶é—´åï¼Œå½“å‰çº¿ç¨‹é‡æ–°è·å–äº† CPU æ—¶é—´ç‰‡ç»§ç»­æ‰§è¡Œæ—¶ï¼Œæ ¹æ®ç¨‹åºè®¡æ•°å™¨å­˜çš„ 6 å°±çŸ¥é“ï¼Œå½“å‰éœ€è¦æ‰§è¡Œ iaddï¼ˆå³ a+b æ“ä½œï¼‰æŒ‡ä»¤ã€‚æ‰§è¡Œå¼•æ“ä¼šå°†è¿™æ¡æŒ‡ä»¤ç¿»è¯‘ä¸ºæœºå™¨æŒ‡ä»¤ï¼Œç„¶å CPU æ‰§è¡Œè¯¥è¿ç®—æ“ä½œã€‚

#### 4.è™šæ‹Ÿæœºæ ˆï¼ˆJava æ ˆï¼‰

è™šæ‹Ÿæœºæ ˆä¹Ÿç§°ä¸º Java æ ˆï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡çš„ Java æ–¹æ³•è°ƒç”¨ã€‚

å’Œ PC å¯„å­˜å™¨ä¸€æ ·ï¼Œè™šæ‹Ÿæœºæ ˆçš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ã€‚

è™šæ‹Ÿæœºæ ˆä¸»ç®¡ Java ç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ï¼ˆ8 ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¯¹è±¡å¼•ç”¨åœ°å€ï¼‰ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/sW06rG.png)

?> JVM å¯¹è™šæ‹Ÿæœºæ ˆçš„æ“ä½œåªæœ‰å‹æ ˆï¼ˆå…¥æ ˆï¼‰å’Œå‡ºæ ˆæ“ä½œï¼Œéµå¾ª FILO åŸåˆ™ï¼›

åœ¨ä¸€ä¸ªæ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹åªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ï¼Œå³å½“å‰æ­£åœ¨æ‰§è¡Œæ–¹æ³•å¯¹åº”çš„æ ˆå¸§ï¼ˆå½“å‰æ ˆå¸§ï¼‰ï¼›

å¦‚æœä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ–°çš„æ ˆå¸§å°†ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆé¡¶ï¼Œæˆä¸ºæ–°çš„å½“å‰æ ˆå¸§ã€‚

```java
package com.xujiajun.stack;

public class Test {
    public static void main(String[] args) {
        new Test().method1();
    }
    void method1() {
        System.out.println("æ–¹æ³•1:å¼€å§‹");
        method2();
        System.out.println("æ–¹æ³•1:ç»“æŸ");
    }
    void method2() {
        System.out.println("æ–¹æ³•2:å¼€å§‹");
        method3();
        System.out.println("æ–¹æ³•2:ç»“æŸ");
    }
    void method3() {
        System.out.println("æ–¹æ³•3:å¼€å§‹");
        method4();
        System.out.println("æ–¹æ³•3:ç»“æŸ");
    }
    void method4() {
        System.out.println("æ–¹æ³•4:å¼€å§‹");
        System.out.println("æ–¹æ³•4:ç»“æŸ");
    }
}

```

!> Java æ–¹æ³•æ‰§è¡Œç»“æŸæ­£å¸¸é€€å‡ºå’ŒæŠ›å‡ºå¼‚å¸¸è¿™ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºï¼ˆé€€å‡ºï¼‰

##### 4.1.è™šæ‹Ÿæœºæ ˆå¤§å°è°ƒæ•´

Java è™šæ‹Ÿæœºè§„èŒƒå…è®¸è™šæ‹Ÿæœºæ ˆçš„å¤§å°å›ºå®šä¸å˜æˆ–è€…åŠ¨æ€æ‰©å±•ã€‚

- å›ºå®šæƒ…å†µä¸‹ï¼šå¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡ Java è™šæ‹Ÿæœºå…è®¸çš„æœ€å¤§å®¹é‡ï¼Œåˆ™æŠ›å‡º StackOverflowError å¼‚å¸¸ï¼›
- å¯åŠ¨æ€æ‰©å±•æƒ…å†µä¸‹ï¼šå°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼›æˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹çš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œåˆ™ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚

ä¸åŒå¹³å°çš„è™šæ‹Ÿæœºæ ˆé»˜è®¤å¤§å°ä¸åŒï¼š

- Linux/x64 (64-bit): 1024 KB
- macOS (64-bit): 1024 KB
- Oracle Solaris/x64 (64-bit): 1024 KB
- Windows: é»˜è®¤å€¼å–å†³äºè™šæ‹Ÿå†…å­˜ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡`-Xss`ï¼ˆ`-XX:ThreadStackSize`ç®€å†™ï¼‰è®¾ç½®è™šæ‹Ÿæœºæ ˆå¤§å°ï¼Œé»˜è®¤å•ä½ä¸ºå­—èŠ‚ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ k æˆ–è€… K æŒ‡å®šå•ä½ä¸º KBï¼Œm æˆ– M æŒ‡å®šå•ä½ä¸º MBï¼Œg æˆ– G æŒ‡å®šå•ä½ä¸º GBã€‚

ä¸‹é¢è¿™ç»„é…ç½®éƒ½æ˜¯å°†è™šæ‹Ÿæœºæ ˆå¤§å°è®¾ç½®ä¸º 1024KBï¼š

```bash
-Xss1m
-Xss1024k
-Xss1048576
```

è™šæ‹Ÿæœºæ ˆè¶Šå¤§ï¼Œæ–¹æ³•è°ƒç”¨æ·±åº¦è¶Šæ·±.

ä¸¾ä¸ªä¾‹å­ï¼š

```java
package com.xujiajun.stack;

public class Test2 {
    private static int count = 1;
    public static void main(String[] args) {
        System.out.println(count);
        count++;
        main(args);
    }
}

```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/UkQMwW.png)

æˆ‘ä»¬é€šè¿‡-Xss200k å‘½ä»¤å°†è™šæ‹Ÿæœºæ ˆå¤§å°è°ƒæ•´ä¸º 200KB å†è§‚å¯Ÿè¾“å‡ºç»“æœï¼š

```
......
1214
1215
1216
1217
1218
1219
*** java.lang.instrument ASSERTION FAILED ***: "!errorOutstanding" with message transform method call failed at JPLISAgent.c line: 844
*** java.lang.instrument ASSERTION FAILED ***: "!errorOutstanding" with message transform method call failed at JPLISAgent.c line: 844
*** java.lang.instrument ASSERTION FAILED ***: "!errorOutstanding" with message transform method call failed at JPLISAgent.c line: 844
Exception in thread "main" java.lang.StackOverflowError
```

å¯ä»¥çœ‹åˆ°ï¼Œæ–¹æ³•è°ƒç”¨æ·±åº¦æ˜æ˜¾å˜å°äº†ã€‚

##### 4.2.æ ˆå¸§å†…éƒ¨ç»“æ„

æ¯ä¸ªæ ˆå¸§åŒ…å« 5 ä¸ªç»„æˆéƒ¨åˆ†ï¼š

- å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰
- æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰
- åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰
- æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰
- ä¸€äº›é™„åŠ ä¿¡æ¯ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/sT5scC.png)

<!-- tabs:start -->

##### **å±€éƒ¨å˜é‡è¡¨**

å±€éƒ¨å˜é‡è¡¨æ˜¯ä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡ã€‚

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/5CHtL1.png)

éé™æ€æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å’Œé™æ€æ–¹æ³•ç›¸æ¯”ï¼Œå¤šäº†ä¸ª this å¯¹è±¡ï¼ˆå³å½“å‰ç±»ï¼‰ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/BEswwh.png)

?> å¯ä»¥çœ‹åˆ°ï¼Œéé™æ€æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨é¦–ä½å°±å­˜æ”¾äº† this å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯é™æ€æ–¹æ³•å†…æ— æ³•ä½¿ç”¨ this çš„åŸå› ï¼ˆå› ä¸ºé™æ€æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ä¸­æ²¡æœ‰ this å¯¹è±¡ï¼‰ã€‚

å±€éƒ¨å˜é‡è¡¨æ•°ç»„å®¹é‡çš„å¤§å°åœ¨ç¼–è¯‘æœŸå°±å¯ä»¥å”¯ä¸€ç¡®å®šä¸‹æ¥ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„ Code å±æ€§çš„`maximum locacl variables`æ•°æ®é¡¹ä¸­:

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/J2y0sS.png)

!> å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ä¸º 3ï¼Œç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šï¼Œä¸ä¼šéšç€æ–¹æ³•çš„è¿è¡Œè€Œæ”¹å˜ï¼

å±€éƒ¨å˜é‡è¡¨çš„æœ€åŸºæœ¬å•å…ƒæ˜¯å˜é‡æ§½ï¼ˆSlotï¼‰ã€‚

å±€éƒ¨å˜é‡è¡¨ä¸­ 32 ä½ä»¥å†…çš„æ•°æ®ç±»å‹ï¼ˆé™¤ long å’Œ double å¤–ï¼‰åªå ç”¨ä¸€ä¸ª slotï¼Œ64 ä½ç±»å‹ï¼ˆlong å’Œ doubleï¼‰å ç”¨ä¸¤ä¸ª slotã€‚

ä¸¾ä¸ªä¾‹å­ï¼š
`java public class Test3 { public void hello(String name) { Date date = new Date(); long number = 200L; double sala = 5500.4; int count = 1; } } `

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/1engBt.png)

**é€šè¿‡å±€éƒ¨å˜é‡è¡¨åŒ…å«çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¾—å‡ºå±€éƒ¨å˜é‡çš„ä½œç”¨èŒƒå›´**

```java
package com.xujiajun.stack;

public class Test3 {
    public static void hello(String name) {
        int count = 1;
    }
}

```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/5xqzEq.png)

ä»¥æ–¹æ³•å‚æ•° name ä¸ºä¾‹ï¼ŒæŸ¥çœ‹ LocalVariableTableï¼Œname å‚æ•°å¯¹åº”çš„ Start åˆ—çš„å€¼ä¸º 0ï¼Œè¡¨ç¤ºå…¶åœ¨ç¬¬ 0 è¡Œå­—èŠ‚ç æŒ‡ä»¤å¤„ç”Ÿæ•ˆï¼ˆé€šè¿‡ LineNumberTable æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œç¬¬ 0 è¡Œå­—èŠ‚ç æŒ‡ä»¤å¯¹åº”ç¨‹åºä¸­çš„ç¬¬ 6 è¡Œä»£ç ï¼‰ï¼›Length åˆ—çš„å€¼ä¸º 3ï¼Œè¯´æ˜ name å‚æ•°çš„æœ‰æ•ˆä½œç”¨åŸŸé•¿åº¦ä¸º 3ï¼Œå› ä¸º name æ˜¯åœ¨ç¬¬ 0 è¡Œå­—èŠ‚ç æŒ‡ä»¤å¤„ç”Ÿæ•ˆçš„ï¼Œæ‰€ä»¥ name åœ¨ 0 ~ 2 è¡Œå­—èŠ‚ç æŒ‡ä»¤èŒƒå›´å†…æœ‰æ•ˆï¼ˆé€šè¿‡ LineNumberTable çš„å¯¹åº”å…³ç³»ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“ name åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ä½œç”¨åŸŸèŒƒå›´ä¸ºç¬¬ 6 è¡Œåˆ°ç¬¬ 7 è¡Œï¼‰ã€‚

**å±€éƒ¨å˜é‡è¡¨çš„æ§½ä½æ˜¯å¯ä»¥é‡å¤åˆ©ç”¨çš„**

å¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜é‡å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½

```java
package com.xujiajun.stack;

public class Test3 {
    public static void hello(String name) {
        {
            int a = 1;
            System.out.println(a);
        }
        int b = 2;
    }
}

```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/0DBtZH.png)

å¯ä»¥çœ‹åˆ°å±€éƒ¨å˜é‡ a å’Œ b çš„æ§½ä½éƒ½æ˜¯ 1ï¼Œè¯´æ˜æ§½ä½é‡å¤åˆ©ç”¨äº†ã€‚è¿™æ˜¯å› ä¸ºåœ¨å®šä¹‰å±€éƒ¨å˜é‡ b çš„æ—¶å€™ï¼Œå±€éƒ¨å˜é‡ a å·²ç»å‡ºäº†ä½œç”¨åŸŸå¤±æ•ˆé”€æ¯äº†ï¼Œä½†æ˜¯å±€éƒ¨å˜é‡è¡¨çš„æ§½ä½å·²ç»å¼€è¾Ÿäº†ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡ b ç›´æ¥é‡å¤åˆ©ç”¨ç´¢å¼•ä¸º 1 çš„æ§½ä½ã€‚

##### **æ“ä½œæ•°æ ˆ**

æ¯ä¸€ä¸ªç‹¬ç«‹çš„æ ˆå¸§ä¸­é™¤äº†åŒ…å«å±€éƒ¨å˜é‡è¡¨å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ª FILO çš„æ“ä½œæ•°æ ˆï¼Œç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´ã€‚æ¯ä¸ªæ“ä½œæ•°æ ˆéƒ½æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ·±åº¦ï¼Œåœ¨ç¼–è¯‘æœŸå·²ç»ç¡®å®šä¸‹æ¥ï¼š

?> æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½å¯ä»¥æ˜¯ä»»æ„çš„ Java æ•°æ®ç±»å‹ï¼Œ32bit çš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆæ·±åº¦ï¼Œ64bit çš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦

?> æ“ä½œæ•°æ ˆåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤å¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œã€‚è™½ç„¶æ ˆæ˜¯ç”¨æ•°ç»„å®ç°çš„ï¼Œä½†æ ¹æ®æ ˆçš„ç‰¹æ€§ï¼Œå¯¹æ ˆä¸­æ•°æ®è®¿é—®ä¸èƒ½é€šè¿‡ç´¢å¼•ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®ã€‚

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ„Ÿå— PC å¯„å­˜å™¨ï¼Œå±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆæ˜¯å¦‚ä½•ç›¸äº’é…åˆå®Œæˆä¸€æ¬¡æ–¹æ³•çš„æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
package com.xujiajun.stack;

public class Test4 {
    public void add() {
        int a = 15;
        int b = 1;
        int c = a + b;
    }
}

```

åœ¨æŸ¥çœ‹å­—èŠ‚ç æŒ‡ä»¤ä¹‹å‰ï¼Œå…ˆè®°å½•ä¸‹å‡ ä¸ªå…¥æ ˆå‡ºæ ˆçš„å­—èŠ‚ç æŒ‡ä»¤å«ä¹‰ï¼š

- å½“ int å–å€¼ -1 ~ 5 é‡‡ç”¨ iconst æŒ‡ä»¤å…¥æ ˆï¼›
- å–å€¼ -128 ~ 127ï¼ˆbyte æœ‰æ•ˆèŒƒå›´ï¼‰é‡‡ç”¨ bipush æŒ‡ä»¤å…¥æ ˆï¼›
- å–å€¼ -32768 ~ 32767ï¼ˆshort æœ‰æ•ˆèŒƒå›´ï¼‰é‡‡ç”¨ sipush æŒ‡ä»¤å…¥æ ˆï¼›
- å–å€¼ -2147483648 ~ 2147483647ï¼ˆint æœ‰æ•ˆèŒƒå›´ï¼‰é‡‡ç”¨ ldc æŒ‡ä»¤å…¥æ ˆï¼›
- istoreï¼Œæ ˆé¡¶å…ƒç´ å‡ºæ ˆï¼Œä¿å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­ï¼›
- iloadï¼Œä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½æ•°æ®å…¥æ ˆã€‚

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/TcSFCU.png)

æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒPC å¯„å­˜å™¨ï¼Œå±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆçŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/BGviRx.png)

!> å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­

##### **åŠ¨æ€é“¾æ¥**

åœ¨ Java æºæ–‡ä»¶è¢«ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ä¿å­˜åœ¨ class æ–‡ä»¶çš„å¸¸é‡æ± é‡Œï¼ŒåŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨

##### **æ–¹æ³•è¿”å›åœ°å€**

å­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„ pc å¯„å­˜å™¨çš„å€¼ã€‚

ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š

- æ­£å¸¸æ‰§è¡Œç»“æŸï¼›
- å‡ºç°æœªå¤„ç†å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡ºã€‚

?> æ— è®ºæ˜¯å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›åˆ°è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®

?> æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„ pc å¯„å­˜å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼›å¼‚å¸¸é€€å‡ºæ—¶ï¼Œè¿”å›åœ°å€éœ€è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šã€‚

##### **ä¸€äº›é™„åŠ ä¿¡æ¯**

æ¯”å¦‚å¯¹ç¨‹åºè°ƒå¼æä¾›çš„æ”¯æŒä¿¡æ¯ã€‚

<!-- tabs:end -->

#### 5.æœ¬åœ°æ–¹æ³•æ¥å£

æœ¬åœ°æ–¹æ³•æ¥å£(Native Interface)çš„ä½œç”¨æ˜¯èåˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸º Java æ‰€ç”¨ï¼Œå®ƒçš„åˆè¡·æ˜¯èåˆ C/C++ç¨‹åºã€‚

Java è¯ç”Ÿçš„æ—¶å€™æ˜¯ C/C++æ¨ªè¡Œçš„æ—¶å€™ï¼Œè¦æƒ³ç«‹è¶³ï¼Œå¿…é¡»è°ƒç”¨ C/C++ç¨‹åºï¼Œäºæ˜¯å°±åœ¨å†…å­˜ä¸­ä¸“é—¨å¼€è¾Ÿäº†ä¸€å—åŒºåŸŸå¤„ç†æ ‡è®°ä¸º native çš„ä»£ç ã€‚

æ¯”å¦‚æŸ¥çœ‹ java.lang.Thread ç±»æºç å°±ä¼šå‘ç°å½“ä¸­å­˜åœ¨è®¸å¤š native æ–¹æ³•ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/2w5cRq.png)

native æ–¹æ³•æ²¡æœ‰æ–¹æ³•ä½“ï¼ˆå› ä¸ºä¸æ˜¯ Java å®ç°ï¼‰ï¼Œæ‰€ä»¥çœ‹ä¸Šå»åƒæ˜¯â€œæ¥å£â€ä¸€æ ·ï¼Œæ•…å¾—åæœ¬åœ°æ–¹æ³•æ¥å£ã€‚

#### 6.æœ¬åœ°æ–¹æ³•æ ˆ

å¦‚å‰æ‰€è¿°ï¼Œè™šæ‹Ÿæœºæ ˆç”¨äºç®¡ç† Java æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™æ˜¯ç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨ã€‚

#### 7.å †ï¼ˆHeapï¼‰

å †ï¼ˆHeapï¼‰ä¸€ä¸ª JVM å®ä¾‹åªå­˜åœ¨ä¸€ä¸ªå †å†…å­˜ï¼Œå †å†…å­˜çš„å¤§å°æ˜¯å¯ä»¥è°ƒèŠ‚çš„ã€‚

å †ä¸­ä¿å­˜ç€æ‰€æœ‰å¼•ç”¨ç±»å‹çš„çœŸå®ä¿¡æ¯ï¼Œä»¥æ–¹ä¾¿æ‰§è¡Œå™¨æ‰§è¡Œã€‚

å †åœ¨é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼š

<!-- tabs:start -->

##### **Java 8**

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/Un47N8.png)

åœ¨ Java7 æ—¶ä»£ï¼Œå †åˆ†ä¸º:

- æ–°ç”ŸåŒº:
  - ä¼Šç”¸å›­åŒº
  - å¹¸å­˜åŒº:
    - å¹¸å­˜è€… 0 åŒº(åˆç§°ä¸º From åŒº)
    - å¹¸å­˜è€… 1 åŒº(åˆç§°ä¸º To åŒº)
      **From åŒºå’Œ To åŒºå¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¤åˆ¶ä¹‹åäº¤äº’ï¼Œè°ç©ºè°æ˜¯ To**
- å…»è€åŒº
- æ°¸ä¹…ä»£ï¼›

?> åœ¨ Java8 ä¸­ï¼Œæ°¸ä¹…ä»£å·²ç»è¢«ç§»é™¤ï¼Œè¢«ä¸€ä¸ªç§°ä¸ºå…ƒç©ºé—´çš„åŒºåŸŸæ‰€å–ä»£ã€‚å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ã€‚

å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šæ°¸ä¹…ä»£ä½¿ç”¨çš„ JVM çš„å †å†…å­˜ï¼Œä½†æ˜¯ java8 ä»¥åçš„å…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­è€Œæ˜¯ä½¿ç”¨æœ¬æœºç‰©ç†å†…å­˜ï¼ˆæ‰€ä»¥åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ç”¨è™šçº¿è¡¨ç¤ºï¼‰ã€‚

?> å †ä¹‹æ‰€ä»¥è¦åˆ†åŒºæ˜¯å› ä¸ºï¼šJava ç¨‹åºä¸­ä¸åŒå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸åŒï¼Œ70%~99%å¯¹è±¡éƒ½æ˜¯ä¸´æ—¶å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡åœ¨æ–°ç”ŸåŒºâ€œæœç”Ÿå¤•æ­»â€ã€‚<br>å¦‚æœæ²¡æœ‰åˆ†åŒºï¼ŒGC æ—¶æœé›†åƒåœ¾éœ€è¦å¯¹æ•´ä¸ªå †å†…å­˜è¿›è¡Œæ‰«æï¼›<br>åˆ†åŒºåï¼Œå›æ”¶è¿™äº›â€œæœç”Ÿå¤•æ­»â€çš„å¯¹è±¡ï¼Œåªéœ€è¦åœ¨å°èŒƒå›´çš„åŒºåŸŸä¸­ï¼ˆæ–°ç”ŸåŒºï¼‰æœé›†åƒåœ¾ã€‚<br>æ‰€ä»¥ï¼Œåˆ†åŒºçš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¸ºäº†ä¼˜åŒ– GC æ€§èƒ½ã€‚

##### **Java 7**

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/1bKbC3.png)

<!-- tabs:end -->

##### 7.1.å †ç©ºé—´å¯¹è±¡åˆ†é…è¿‡ç¨‹

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è®²è¿°è¿™å‡ ä¸ªåŒºçš„äº¤äº’é€»è¾‘ï¼š

1. å‡ ä¹ä»»ä½•æ–°çš„å¯¹è±¡éƒ½æ˜¯åœ¨ä¼Šç”¸å›­åŒºè¢« new å‡ºæ¥åˆ›å»ºï¼Œåˆšå¼€å§‹çš„æ—¶å€™ä¸¤ä¸ªå¹¸å­˜è€…åŒºå’Œå…»è€åŒºéƒ½æ˜¯ç©ºçš„ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/vEBJTw.png)

2. éšç€å¯¹è±¡çš„ä¸æ–­åˆ›å»ºï¼Œä¼Šç”¸å›­åŒºç©ºé—´é€æ¸è¢«å¡«æ»¡ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/w2dQ8v.png)

3. è¿™æ—¶å€™å°†è§¦å‘ä¸€æ¬¡ Minor GCï¼ˆYoung GCï¼‰ï¼Œåˆ é™¤æœªå¼•ç”¨çš„å¯¹è±¡ï¼ŒGC å‰©ä¸‹æ¥çš„è¿˜å­˜åœ¨å¼•ç”¨çš„å¯¹è±¡å°†ç§»åŠ¨åˆ°å¹¸å­˜è€… 0 åŒºï¼Œç„¶åæ¸…ç©ºä¼Šç”¸å›­åŒºï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/9VCGNB.png)

4. éšç€å¯¹è±¡çš„åˆ›å»ºï¼Œä¼Šç”¸å›­åŒºç©ºé—´åˆæ»¡äº†ï¼Œå†ä¸€æ¬¡è§¦å‘ Minor GCï¼Œåˆ é™¤æœªå¼•ç”¨çš„å¯¹è±¡ï¼Œç•™ä¸‹å­˜åœ¨å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™æ¬¡å’Œä¸Šä¸€æ¬¡ Minor GC æœ‰äº›ä¸åŒï¼Œè¿™è½® GC ç•™ä¸‹çš„å¯¹è±¡å°†è¢«ç§»åŠ¨åˆ°å¹¸å­˜è€… 1 åŒºï¼Œå¹¶ä¸”ä¸Šä¸€è½® GC ç•™ä¸‹æ¥çš„å­˜å‚¨åœ¨å¹¸å­˜è€… 0 åŒºçš„å¯¹è±¡å¹´é¾„é€’å¢å¹¶ç§»åŠ¨åˆ°å¹¸å­˜è€… 1 åŒºã€‚å½“æ‰€æœ‰å¹¸å­˜å¯¹è±¡éƒ½ç§»åŠ¨åˆ°å¹¸å­˜è€… 1 åŒºåï¼Œå¹¸å­˜è€… 0 åŒºå’Œä¼Šç”¸å›­åŒºç©ºé—´æ¸…é™¤ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/3mtVU6.png)

5. éšç€å¯¹è±¡çš„åˆ›å»ºä¼Šç”¸å›­åŒºç©ºé—´å†ä¸€æ¬¡æ»¡äº†ï¼Œè§¦å‘äº†ç¬¬ä¸‰æ¬¡ Minor GCï¼Œè¿™ä¸€æ¬¡å¹¸å­˜åŒºç©ºé—´å°†å‘ç”Ÿäº’æ¢ï¼ŒGC ç•™ä¸‹æ¥çš„å¹¸å­˜è€…å°†ç§»åŠ¨åˆ°å¹¸å­˜è€… 0 åŒºï¼Œå¹¸å­˜è€… 1 åŒºçš„å¹¸å­˜å¯¹è±¡å¹´é¾„é€’å¢åä¹Ÿç§»åŠ¨åˆ°å¹¸å­˜è€… 0 åŒºï¼Œç„¶åä¼Šç”¸å›­åŒºå’Œå¹¸å­˜è€… 1 åŒºçš„ç©ºé—´è¢«æ¸…é™¤ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/DoqZjB.png)

6. éšç€ Minor GC çš„ä¸æ–­å‘ç”Ÿï¼Œå¹¸å­˜å¯¹è±¡åœ¨ä¸¤ä¸ªå¹¸å­˜åŒºä¸æ–­åœ°äº¤æ¢å­˜å‚¨ï¼Œå¹´é¾„ä¹Ÿä¸æ–­é€’å¢ã€‚å¦‚æ­¤ååå¤å¤ä¹‹åï¼Œå½“å¹¸å­˜å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°æŒ‡å®šçš„é˜ˆå€¼ï¼ˆè¿™ä¸ªä¾‹å­ä¸­æ˜¯ 8ï¼Œç”± JVM å‚æ•° MaxTenuringThreshold å†³å®šï¼‰åï¼Œå®ƒä»¬å°†è¢«ç§»åŠ¨åˆ°å…»è€åŒºï¼š
   ![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/BPcHQA.png)

7. éšç€ä¸Šè¿°è¿‡ç¨‹çš„ä¸æ–­å‡ºç°ï¼Œå½“å…»è€åŒºå¿«æ»¡æ—¶ï¼Œå°†è§¦å‘ Major GCï¼ˆFull GCï¼‰è¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç†ã€‚è‹¥å…»è€åŒºæ‰§è¡Œäº† GC ä¹‹åå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”Ÿ OOM å¼‚å¸¸ã€‚

ä¸€ä¸ªå¯¹è±¡è¢«æ”¾ç½®åˆ°å…»è€åŒºé™¤äº†å®ƒçš„å¹´é¾„è¾¾åˆ°é˜ˆå€¼å¤–ï¼Œä»¥ä¸‹å‡ ç§æƒ…å†µä¹Ÿä¼šä½¿å¾—è¯¥å¯¹è±¡ç›´æ¥è¢«æ”¾ç½®åˆ°å…»è€åŒºï¼š

1. å¯¹è±¡åˆ›å»ºåï¼Œæ— æ³•æ”¾ç½®åˆ°ä¼Šç”¸å›­åŒºï¼ˆæ¯”å¦‚ä¼Šç”¸å›­åŒºçš„å¤§å°ä¸º 10mï¼Œæ–°çš„å¯¹è±¡å¤§å°ä¸º 11mï¼Œä¼Šç”¸å›­åŒºä¸å¤Ÿæ”¾ï¼Œè§¦å‘ YGCã€‚YGC åä¼Šç”¸å›­åŒºè¢«æ¸…ç©ºï¼Œä½†è¿˜æ˜¯æ— æ³•å®¹ä¸‹ 11m çš„â€œè¶…å¤§å¯¹è±¡â€ï¼Œæ‰€ä»¥ç›´æ¥æ”¾ç½®åˆ°å…»è€åŒºã€‚å½“ç„¶å¦‚æœå…»è€åŒºæ”¾ç½®ä¸ä¸‹åˆ™ä¼šè§¦å‘ FGCï¼ŒFGC åè¿˜æ”¾ä¸ä¸‹åˆ™ OOMï¼‰ï¼›
2. YGC åï¼Œå¯¹è±¡æ— æ³•æ”¾ç½®åˆ°å¹¸å­˜è€… To åŒºä¹Ÿä¼šç›´æ¥æ™‹å‡åˆ°å…»è€åŒºï¼›
3. å¦‚æœå¹¸å­˜åŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°å¤§äºå¹¸å­˜åŒºç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¿™äº›å¯¹è±¡å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥å…»è€åŒºï¼Œæ— éœ€ç­‰åˆ°å¹´é¾„é˜ˆå€¼ã€‚

##### 7.2.å †å‚æ•°

ä»¥ JDK1.8+HotSpot ä¸ºä¾‹ï¼Œå¸¸ç”¨çš„å¯è°ƒæ•´çš„å †å‚æ•°æœ‰ï¼š

| å‚æ•°                            | å«ä¹‰                                                                                                                                                                    |
| :------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -Xmsï¼Œç­‰ä»·äº-XX:InitialHeapSize | è®¾ç½®å †çš„åˆå§‹å†…å­˜å¤§å°ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„ 1/64                                                                                                                             |
| -Xmxï¼Œç­‰ä»·äº-XX:MaxHeapSize     | è®¾ç½®å †çš„æœ€å¤§å†…å­˜å¤§å°ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„ 1/4                                                                                                                              |
| -XX:Newratio                    | è®¾ç½®æ–°ç”ŸåŒºå’Œå…»è€åŒºçš„æ¯”ä¾‹ï¼Œæ¯”å¦‚å€¼ä¸º 2ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™å…»è€åŒºæ˜¯æ–°ç”ŸåŒºçš„ 2 å€ï¼Œå³å…»è€åŒºå æ®å †å†…å­˜çš„ 2/3                                                                       |
| -XX:Surviorratio                | è®¾ç½®ä¼Šç”¸å›­åŒºå’Œä¸€ä¸ªå¹¸å­˜åŒºçš„æ¯”ä¾‹ï¼Œæ¯”å¦‚å€¼ä¸º 8ï¼ˆé»˜è®¤å€¼ï¼‰åˆ™è¡¨ç¤ºä¼Šç”¸å›­åŒºå æ–°ç”ŸåŒºçš„ 8/10ï¼ˆä¸¤ä¸ªå¹¸å­˜åŒºæ˜¯ä¸€æ ·å¤§çš„ï¼Œ8:1:1ï¼‰ï¼› å¦‚æœè®¾ç½®ä¸º 5ï¼Œåˆ™æ¯”ä¾‹ä¸º 5:1:1ï¼Œå³ä¼Šç”¸å›­åŒºå æ–°ç”ŸåŒº 5/7 |
| -Xmn                            | è®¾ç½®å †æ–°ç”ŸåŒºçš„å†…å­˜å¤§å°ï¼ˆä¸€èˆ¬ä¸ä½¿ç”¨ï¼‰                                                                                                                                    |
| -XX:MaxTenuringThreshold        | è®¾ç½®è½¬å…¥å…»è€åŒºçš„å­˜æ´»æ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸º 15                                                                                                                                   |
| -XX:+PrintFlagsInitial          | æŸ¥çœ‹æ‰€æœ‰å‚æ•°çš„é»˜è®¤åˆå§‹å€¼                                                                                                                                                |
| -XX:+PrintFlagsFinal            | æŸ¥çœ‹æ‰€æœ‰å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆè¢«æˆ‘ä»¬ä¿®æ”¹åçš„å€¼ä¸å†æ˜¯é»˜è®¤åˆå§‹å€¼ï¼‰                                                                                                                |

å‰©ä¸‹æ‰€æœ‰å¯ç”¨å‚æ•°å¯ä»¥æŸ¥çœ‹ oracle å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.htmlã€‚

!> **ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ¨èå°†-Xms å’Œ-Xmx è®¾ç½®ä¸ºä¸€æ ·å¤§ï¼Œå› ä¸ºè¿™æ ·åšçš„è¯åœ¨ Java åƒåœ¾å›æ”¶æ¸…ç†å®Œå †åŒºåä¸éœ€è¦é‡æ–°è®¡ç®—å †åŒºå¤§å°ï¼Œä»è€Œæé«˜æ€§èƒ½**ã€‚

æ­¤å¤–ï¼Œè¦åœ¨ç¨‹åºä¸­è¾“å‡ºè¯¦ç»†çš„ GC å¤„ç†æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨`-XX:+PrintGCDetails`ã€‚

```java
public class Test {
    public static void main(String[] args) {
        long maxMemory = Runtime.getRuntime().maxMemory();
        long totalMemory = Runtime.getRuntime().totalMemory();
        System.out.println("å †å†…å­˜çš„åˆå§‹å€¼" + totalMemory / 1024 / 1024 + "mb");
        System.out.println("å †å†…å­˜çš„æœ€å¤§å€¼" + maxMemory / 1024 / 1024 + "mb");
    }
}
```

```
å †å†…å­˜çš„åˆå§‹å€¼245mb
å †å†…å­˜çš„æœ€å¤§å€¼3641mb
```

å¯ä»¥é€šè¿‡ IDEA è°ƒæ•´å †çš„å¤§å°ï¼š

```shell
-Xms10m -Xmx10m -XX:+PrintGCDetails
```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/61JSOl.png)

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/zoO7aY.png)

å¯ä»¥çœ‹åˆ°ï¼ŒPSYoungGenï¼ˆæ–°ç”ŸåŒºï¼‰çš„æ€»å†…å­˜å¤§å°ä¸º 2560kï¼ŒParOldGenï¼ˆå…»è€åŒºï¼‰çš„æ€»å†…å­˜å¤§å°ä¸º 7168kï¼Œæ€»å’Œåˆšå¥½æ˜¯ 9728Kï¼Œè¿™ä¹Ÿè¯´æ˜äº†ï¼šJava8 åçš„å †ç‰©ç†ä¸Šåªåˆ†ä¸ºæ–°ç”ŸåŒºå’Œå…»è€åŒºï¼ŒMetaspaceï¼ˆå…ƒç©ºé—´ï¼‰ä¸å ç”¨å †å†…å­˜ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜ã€‚

!> é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬è®¾ç½®çš„å †å†…å­˜å¤§å°æ˜¯ 10mï¼ˆ10240kbï¼‰ï¼Œæ§åˆ¶å°è¾“å‡ºå´åªæœ‰ 9728kb å‘¢ï¼Ÿä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬çŸ¥é“ï¼Œå¹¸å­˜è€…åŒºåˆ†ä¸º 0 åŒºå’Œ 1 åŒºï¼Œæ ¹æ®å¤åˆ¶ç®—æ³•çš„ç‰¹ç‚¹ï¼Œè¿™ä¸¤ä¸ªåŒºåŒä¸€æ—¶åˆ»æ€»æœ‰ä¸€ä¸ªåŒºæ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æ§åˆ¶å°è¾“å‡ºçš„å†…å­˜è®¡ç®—æ–¹å¼ä¸ºï¼š2048K(eden space)+512K(from space or to space)+7168K(ParOldGen)=9728Kã€‚9728K å†åŠ ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å° 512K åˆšå¥½æ˜¯ 10240Kã€‚

å†ä¸¾ä¸ª OOM çš„ä¾‹å­ï¼Œä½¿ç”¨åˆšåˆš`-Xms10m -Xmx10m -XX:+PrintGCDetails`çš„è®¾ç½®ï¼Œè¿è¡Œä¸‹é¢è¿™æ®µç¨‹åºï¼š

```java
public class OMMTest {
    public static void main(String[] args) {
        String value = "hello";
        while (true) {
            value += value + new Random().nextInt(1000000000) + new Random().nextInt(1000000000);
        }
    }
}
```

```shell
[GC (Allocation Failure) [PSYoungGen: 1941K->486K(2560K)] 1941K->654K(9728K), 0.0027871 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 2189K->368K(2560K)] 2357K->1075K(9728K), 0.0004010 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 1860K->503K(2560K)] 2568K->1723K(9728K), 0.0004052 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 2001K->272K(2560K)] 4661K->3651K(9728K), 0.0005188 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 1051K->240K(2560K)] 5870K->5058K(9728K), 0.0004505 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 240K->240K(1536K)] 5058K->5058K(8704K), 0.0002655 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[Full GC (Allocation Failure) [PSYoungGen: 240K->0K(1536K)] [ParOldGen: 4818K->2516K(7168K)] 5058K->2516K(8704K), [Metaspace: 3143K->3143K(1056768K)], 0.0023909 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 43K->64K(2048K)] 6878K->6899K(9216K), 0.0003698 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[Full GC (Ergonomics) [PSYoungGen: 64K->0K(2048K)] [ParOldGen: 6835K->1796K(7168K)] 6899K->1796K(9216K), [Metaspace: 3146K->3146K(1056768K)], 0.0023337 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]
[GC (Allocation Failure) [PSYoungGen: 23K->64K(2048K)] 6138K->6179K(9216K), 0.0003372 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 64K->32K(2048K)] 6179K->6147K(9216K), 0.0002256 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[Full GC (Allocation Failure) [PSYoungGen: 32K->0K(2048K)] [ParOldGen: 6115K->4675K(7168K)] 6147K->4675K(9216K), [Metaspace: 3146K->3146K(1056768K)], 0.0013695 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[GC (Allocation Failure) [PSYoungGen: 0K->0K(2048K)] 4675K->4675K(9216K), 0.0002573 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[Full GC (Allocation Failure) [PSYoungGen: 0K->0K(2048K)] [ParOldGen: 4675K->4656K(7168K)] 4675K->4656K(9216K), [Metaspace: 3146K->3146K(1056768K)], 0.0021235 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
Heap
 PSYoungGen      total 2048K, used 59K [0x00000007bfd00000, 0x00000007c0000000, 0x00000007c0000000)
  eden space 1024K, 5% used [0x00000007bfd00000,0x00000007bfd0ef70,0x00000007bfe00000)
  from space 1024K, 0% used [0x00000007bff00000,0x00000007bff00000,0x00000007c0000000)
  to   space 1024K, 0% used [0x00000007bfe00000,0x00000007bfe00000,0x00000007bff00000)
 ParOldGen       total 7168K, used 4656K [0x00000007bf600000, 0x00000007bfd00000, 0x00000007bfd00000)
  object space 7168K, 64% used [0x00000007bf600000,0x00000007bfa8c268,0x00000007bfd00000)
 Metaspace       used 3187K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 351K, capacity 388K, committed 512K, reserved 1048576K
Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOf(Arrays.java:3332)
	at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)
	at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:674)
	at java.lang.StringBuilder.append(StringBuilder.java:208)
	at com.xujiajun.heep.OMMTest.main(OMMTest.java:14)

è¿›ç¨‹å·²ç»“æŸ,é€€å‡ºä»£ç 1

```

å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡æ•°æ¬¡çš„ GC å’Œ Full GC åï¼Œå †å†…å­˜è¿˜æ˜¯æ— æ³•è…¾å‡ºç©ºé—´ï¼Œæœ€ç»ˆæŠ›å‡º OOM é”™è¯¯ã€‚

æ—¥å¿—çš„å«ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<!-- tabs:start -->

##### **Young GCï¼ˆMinor GCï¼‰ï¼š**

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/1isrRi.png)

##### **Full GCï¼ˆMajor GCï¼‰ï¼š**

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/C2jhhQ.png)

<!-- tabs:end -->

##### 7.3.TLAB

JVM å¯¹ä¼Šç”¸å›­åŒºç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œè¿™å—åŒºåŸŸå°±æ˜¯ TLABï¼ˆThread Local Allocation Bufferï¼‰ã€‚

å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨ TLAB å¯ä»¥é¿å…ä¸€ç³»åˆ—éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿæå‡å†…å­˜åˆ†é…çš„ååé‡ã€‚

å°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨ TLAB ä¸­æˆåŠŸåˆ†é…å†…å­˜ï¼Œä½† JVM ç¡®å®æ˜¯å°† TLAB ä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/Xqznyc.png)
![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/xJj8ui.png)

ä½¿ç”¨`-XX:UseTLAB`è®¾ç½®æ˜¯å¦å¼€å¯ TLAB

```java
public class Test2 {

    public static void main(String[] args) throws InterruptedException {
        TimeUnit.SECONDS.sleep(100);
    }
}
```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/0PMS8I.png)

å¯ä»¥çœ‹åˆ° TLAB é»˜è®¤æ˜¯å¼€å¯çš„ã€‚

TLAB ç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æ•´ä¸ªä¼Šç”¸å›­åŒºçš„ 1%ï¼Œå¯ä»¥é€šè¿‡`-XX:TLABWasteTargetPercent`è®¾ç½® TLAB ç©ºé—´æ‰€å ç”¨ä¼Šç”¸å›­åŒºç©ºé—´çš„ç™¾åˆ†æ¯”ã€‚

!> æœ‰äº† TLAB çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬å°±ä¸èƒ½è¯´å †ç©ºé—´ä¸€å®šæ˜¯çº¿ç¨‹å…±äº«çš„äº†ã€‚

#### 8.æ–¹æ³•åŒº

**æ–¹æ³•åŒº**å¹¶ä¸æ˜¯æ‰€è°“çš„~~å­˜å‚¨æ–¹æ³•çš„åŒºåŸŸ~~ï¼Œè€Œæ˜¯ä¾›å„çº¿ç¨‹å…±äº«çš„è¿è¡Œæ—¶å†…å­˜åŒºåŸŸã€‚

å®ƒå­˜å‚¨äº†å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚

æ–¹æ³•åŒºä¹Ÿæ˜¯**ä¸€ç§è§„èŒƒ**ï¼Œåœ¨ä¸åŒè™šæ‹Ÿæœºé‡Œå¤´å®ç°æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€å…¸å‹çš„å®ç°å°±æ˜¯ HotSpot è™šæ‹Ÿæœº Java8 ä¹‹å‰çš„æ°¸ä¹…ä»£(PermGen space)å’Œ Java8 çš„å…ƒç©ºé—´(Metaspace)ã€‚

##### 8.1.è®¾ç½®æ–¹æ³•åŒºå¤§å°

æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥åŠ è½½å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹Ÿæœºåˆ™ä¼šæŠ›å‡º`java.lang.OutOfMemoryError: PermGen spaceï¼ˆJava 7ï¼‰`æˆ–è€…`java.lang.OutOfMemoryError: Metaspaceï¼ˆJava 8ï¼‰`å†…å­˜æº¢å‡ºé”™è¯¯ã€‚

ä»¥ Java8 ç‰ˆæœ¬ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`-XX:MetaspaceSize=size`è®¾ç½®å…ƒç©ºé—´åˆå§‹å¤§å°ï¼Œ`-XX:MaxMetaspaceSize=size`è®¾ç½®å…ƒç©ºé—´æœ€å¤§å€¼ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ windows å¹³å°ä¸Šï¼Œ`-XX:MetaspaceSize`å€¼ä¸º 21Mï¼Œ`-XX:MaxMetaspaceSize`å€¼ä¸º-1ï¼Œå³æ²¡æœ‰é™åˆ¶ï¼Œæ‰€ä»¥æç«¯æƒ…å†µä¸‹å¦‚æœä¸æ–­åœ°åŠ è½½ç±»ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰å¯ç”¨çš„ç³»ç»Ÿå†…å­˜ã€‚

å…ƒç©ºé—´ OOM çš„ä¾‹å­

```java
package com.xujiajun.meta;

import jdk.internal.org.objectweb.asm.ClassWriter;
import jdk.internal.org.objectweb.asm.Opcodes;

public class Test extends ClassLoader {
    public static void main(String[] args) {
        int count = 0;
        try {
            Test test = new Test();
            for (int i = 0; i < 10000; i++) {
                String className = "Class" + i;
                // åˆ›å»ºClassWriterå¯¹è±¡ï¼Œç”¨äºç”Ÿæˆç±»çš„äºŒè¿›åˆ¶å­—èŠ‚ç 
                ClassWriter classWriter = new ClassWriter(0);
                // æŒ‡å®šç‰ˆæœ¬å·ã€ä¿®é¥°ç¬¦ã€ç±»åã€åŒ…åã€çˆ¶ç±»å’Œæ¥å£
                classWriter.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, className, null, "java/lang/Object", null);
                byte[] bytes = classWriter.toByteArray();
                // åŠ è½½ç±»
                test.defineClass(className, bytes, 0, bytes.length);
                count++;
            }
        } finally {
            System.out.println(count);
        }
    }
}

```

ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°è¯•åŠ è½½ 10000 ä¸ªç±»ï¼Œé€šè¿‡å‚æ•°`-XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=10m`å°†å…ƒç©ºé—´å¤§å°è®¾ç½®ä¸ºå›ºå®šå¤§å° 10Mï¼Œè¿è¡Œä¸Šé¢çš„ç¨‹åºæ§åˆ¶å°è¾“å‡ºï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/kiU8Gn.png)

##### 8.2.æ–¹æ³•åŒºã€å †ã€æ ˆå…³ç³»

æ–¹æ³•åŒºå’Œå †ã€æ ˆçš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```java
public class Bird {

    public static void main(String[] args) {
        Bird bird = new Bird();
    }
}
```

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/PbLBjb.png)

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/jm9a7M.png)

##### 8.3.æ–¹æ³•åŒºå†…éƒ¨ç»“æ„

æ–¹æ³•åŒºå†…éƒ¨ä¸»è¦å­˜å‚¨äº†ä»¥ä¸‹å†…å®¹ï¼ˆä¸åŒ JDK ç‰ˆæœ¬å†…å®¹æœ‰æ‰€ä¸åŒï¼Œå…·ä½“å‚è€ƒä¸‹é¢â€œæ–¹æ³•åŒºæ¼”è¿›â€ï¼‰ï¼š

###### 8.3.1.ç±»å‹ä¿¡æ¯

å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±» classã€æ¥å£ interfaceã€æšä¸¾ enumã€æ³¨è§£ annotationï¼‰ï¼ŒJVM å¿…é¡»åœ¨æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š

1. è¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆåç§°ï¼ˆåŒ…å.ç±»åï¼‰ï¼›
2. è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆåï¼ˆinterface å’Œ java.lang.Object æ²¡æœ‰çˆ¶ç±»ï¼‰ï¼›
3. è¿™ä¸ªç±»çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œabstractï¼Œfinalï¼‰ï¼›
4. è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼ˆä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼‰ã€‚

###### 8.3.2.æ–¹æ³•ä¿¡æ¯

æ–¹æ³•ä¿¡æ¯åŒ…å«äº†è¿™ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ„é€ å™¨ï¼‰ï¼Œè¿™äº›ä¿¡æ¯å’Œå…¶å£°æ˜é¡ºåºä¸€è‡´ï¼š

1. æ–¹æ³•åç§°ï¼›
2. æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼ˆæ²¡æœ‰è¿”å›å€¼åˆ™æ˜¯ voidï¼‰ï¼›
3. æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹ï¼ˆæœ‰åºï¼‰ï¼›
4. æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œsynchronizedï¼Œnativeï¼Œabstractï¼‰ï¼›
5. æ–¹æ³•çš„å­—èŠ‚ç ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå…¶å¤§å°ï¼ˆabstract å’Œ native æ–¹æ³•é™¤å¤–ï¼‰ï¼›
6. å¼‚å¸¸è¡¨ï¼ˆabstract å’Œ native æ–¹æ³•é™¤å¤–ï¼‰ã€‚

###### 8.3.3.åŸŸä¿¡æ¯

åŸŸ Field æˆ‘ä»¬ä¹Ÿå¸¸ç§°ä¸ºå±æ€§ï¼Œå­—æ®µã€‚åŸŸä¿¡æ¯åŒ…å«ï¼š

1. åŸŸçš„å£°æ˜é¡ºåºï¼›
2. åŸŸçš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€ç±»å‹ã€ä¿®é¥°ç¬¦ï¼ˆpublicï¼Œprivateï¼Œprotectedï¼Œstaticï¼Œfinalï¼Œvolatileï¼Œtransientï¼‰ã€‚

###### 8.3.4.JIT ä»£ç ç¼“å­˜

è¿™éƒ¨åˆ†åœ¨ ğŸ‘‡ æ‰§è¡Œå¼•æ“ä¸­å†åšè¯´æ˜ã€‚

###### 8.3.5.è¿è¡Œæ—¶å¸¸é‡æ± 

åœ¨ä¸Šé¢è™šæ‹Ÿæœºæ ˆçš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ç±»å­—èŠ‚ç åç¼–è¯‘åï¼Œä¼šæœ‰ä¸€ä¸ª constant pool çš„ç»“æ„ï¼Œä¿—ç§°ä¸ºå¸¸é‡æ± ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ä¿å­˜åœ¨ class æ–‡ä»¶çš„å¸¸é‡æ± é‡Œã€‚è™šæ‹Ÿæœºæ ˆçš„åŠ¨æ€é“¾æ¥å°±æ˜¯å°†ç¬¦å·å¼•ç”¨ï¼ˆè¿™äº›ç¬¦å·å¼•ç”¨çš„é›†åˆå°±æ˜¯å¸¸é‡æ± ï¼‰è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆç¬¦å·å¼•ç”¨å¯¹åº”çš„å…·ä½“ä¿¡æ¯ï¼Œè¿™äº›å…·ä½“ä¿¡æ¯çš„é›†åˆå°±æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå­˜åœ¨æ–¹æ³•åŒºä¸­ï¼‰çš„è¿‡ç¨‹ã€‚

###### 8.3.6.é™æ€å˜é‡

é™æ€å˜é‡å°±æ˜¯ä½¿ç”¨ static ä¿®é¥°çš„åŸŸä¿¡æ¯ã€‚é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œå®ƒä»¬æˆä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†ã€‚é™æ€å˜é‡ä¹Ÿæˆä¸ºç±»å˜é‡ï¼Œç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰ç±»å®ä¾‹æ—¶ä½ ä¹Ÿå¯ä»¥è®¿é—®å®ƒï¼š

```java
public class Test {

    private static String hello = "hello";

    private static void hello() {
        System.out.println("hello");
    }

    public static void main(String[] args) {
        Test test = null;
        test.hello();
        System.out.println(test.hello);
    }
}
```

ä¸Šé¢ç¨‹åºè¿è¡Œå¹¶ä¸ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚

é€šè¿‡ final ä¿®é¥°çš„é™æ€å˜é‡æˆ‘ä»¬ä¿—ç§°å¸¸é‡ã€‚å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…å…·ä½“å€¼ï¼š

```java
public class Test {

    private static String hello = "hello";
    private static final String HELLO = "hello";
}
```

é€šè¿‡`javap -v -p Test.class`æŸ¥çœ‹å…¶å­—èŠ‚ç ï¼š

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/jyIgoZ.png)

é€šè¿‡ä¸Šé¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œé™æ€å˜é‡ï¼ˆç±»å˜é‡ï¼‰åœ¨ç±»åŠ è½½è¿‡ç¨‹çš„åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šè¢«èµ‹å€¼ã€‚

###### 8.3.7.æ¼”ç¤ºæ–¹æ³•åŒºå†…éƒ¨ç»“æ„

```java
public class Test extends Object implements Cloneable, Serializable {

    private static String hello = "hello";
    private static final String HELLO = "hello";
    public int a = 0;

    public void method1() {
        System.out.println("method1");
    }

    public static String method2(String name) {
        try {
            int a = 1;
            int b = a / 0;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return name;
    }
}
```

```shell
xujiajun@bogon meta % clear
xujiajun@bogon meta % javac -g Test2.java
xujiajun@bogon meta % javap -v -p Test2.class
Classfile /Users/xujiajun/Documents/Project/java-source-study/study-27-java-jvm/src/main/java/com/xujiajun/meta/Test2.class
  Last modified 2022å¹´6æœˆ21æ—¥; size 1012 bytes
  SHA-256 checksum 9818a33995c2967fa4ab1a035c784cae9f69e9ac200e789ad1f868bcc773147a
  Compiled from "Test2.java"
public class com.xujiajun.meta.Test2 implements java.lang.Cloneable,java.io.Serializable
  minor version: 0
  major version: 58
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #8                          // com/xujiajun/meta/Test2
  super_class: #2                         // java/lang/Object
  interfaces: 2, fields: 3, methods: 4, attributes: 1
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object."<init>":()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // "<init>":()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               <init>
   #6 = Utf8               ()V
   #7 = Fieldref           #8.#9          // com/xujiajun/meta/Test2.a:I
   #8 = Class              #10            // com/xujiajun/meta/Test2
   #9 = NameAndType        #11:#12        // a:I
  #10 = Utf8               com/xujiajun/meta/Test2
  #11 = Utf8               a
  #12 = Utf8               I
  #13 = Fieldref           #14.#15        // java/lang/System.out:Ljava/io/PrintStream;
  #14 = Class              #16            // java/lang/System
  #15 = NameAndType        #17:#18        // out:Ljava/io/PrintStream;
  #16 = Utf8               java/lang/System
  #17 = Utf8               out
  #18 = Utf8               Ljava/io/PrintStream;
  #19 = String             #20            // method1
  #20 = Utf8               method1
  #21 = Methodref          #22.#23        // java/io/PrintStream.println:(Ljava/lang/String;)V
  #22 = Class              #24            // java/io/PrintStream
  #23 = NameAndType        #25:#26        // println:(Ljava/lang/String;)V
  #24 = Utf8               java/io/PrintStream
  #25 = Utf8               println
  #26 = Utf8               (Ljava/lang/String;)V
  #27 = Class              #28            // java/lang/Exception
  #28 = Utf8               java/lang/Exception
  #29 = Methodref          #27.#30        // java/lang/Exception.printStackTrace:()V
  #30 = NameAndType        #31:#6         // printStackTrace:()V
  #31 = Utf8               printStackTrace
  #32 = String             #33            // hello
  #33 = Utf8               hello
  #34 = Fieldref           #8.#35         // com/xujiajun/meta/Test2.hello:Ljava/lang/String;
  #35 = NameAndType        #33:#36        // hello:Ljava/lang/String;
  #36 = Utf8               Ljava/lang/String;
  #37 = Class              #38            // java/lang/Cloneable
  #38 = Utf8               java/lang/Cloneable
  #39 = Class              #40            // java/io/Serializable
  #40 = Utf8               java/io/Serializable
  #41 = Utf8               HELLO
  #42 = Utf8               ConstantValue
  #43 = Utf8               Code
  #44 = Utf8               LineNumberTable
  #45 = Utf8               LocalVariableTable
  #46 = Utf8               this
  #47 = Utf8               Lcom/xujiajun/meta/Test2;
  #48 = Utf8               method2
  #49 = Utf8               (Ljava/lang/String;)Ljava/lang/String;
  #50 = Utf8               e
  #51 = Utf8               Ljava/lang/Exception;
  #52 = Utf8               name
  #53 = Utf8               StackMapTable
  #54 = Utf8               <clinit>
  #55 = Utf8               SourceFile
  #56 = Utf8               Test2.java
{
  private static java.lang.String hello;
    descriptor: Ljava/lang/String;
    flags: (0x000a) ACC_PRIVATE, ACC_STATIC

  private static final java.lang.String HELLO;
    descriptor: Ljava/lang/String;
    flags: (0x001a) ACC_PRIVATE, ACC_STATIC, ACC_FINAL
    ConstantValue: String hello

  public int a;
    descriptor: I
    flags: (0x0001) ACC_PUBLIC

  public com.xujiajun.meta.Test2();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: aload_0
         5: iconst_0
         6: putfield      #7                  // Field a:I
         9: return
      LineNumberTable:
        line 5: 0
        line 9: 4
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      10     0  this   Lcom/xujiajun/meta/Test2;

  public void method1();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #13                 // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #19                 // String method1
         5: invokevirtual #21                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
      LineNumberTable:
        line 12: 0
        line 13: 8
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       9     0  this   Lcom/xujiajun/meta/Test2;

  public static java.lang.String method2(java.lang.String);
    descriptor: (Ljava/lang/String;)Ljava/lang/String;
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=3, args_size=1
         0: iconst_1
         1: istore_1
         2: iload_1
         3: iconst_0
         4: idiv
         5: istore_2
         6: goto          14
         9: astore_1
        10: aload_1
        11: invokevirtual #29                 // Method java/lang/Exception.printStackTrace:()V
        14: aload_0
        15: areturn
      Exception table:
         from    to  target type
             0     6     9   Class java/lang/Exception
      LineNumberTable:
        line 17: 0
        line 18: 2
        line 21: 6
        line 19: 9
        line 20: 10
        line 22: 14
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            2       4     1     a   I
           10       4     1     e   Ljava/lang/Exception;
            0      16     0  name   Ljava/lang/String;
      StackMapTable: number_of_entries = 2
        frame_type = 73 /* same_locals_1_stack_item */
          stack = [ class java/lang/Exception ]
        frame_type = 4 /* same */

  static {};
    descriptor: ()V
    flags: (0x0008) ACC_STATIC
    Code:
      stack=1, locals=0, args_size=0
         0: ldc           #32                 // String hello
         2: putstatic     #34                 // Field hello:Ljava/lang/String;
         5: return
      LineNumberTable:
        line 7: 0
}
SourceFile: "Test2.java"
xujiajun@bogon meta %


```

##### 8.4.æ–¹æ³•åŒºçš„æ¼”è¿›

éšç€ JDK çš„è¿­ä»£å‡çº§ï¼ŒHotspot ä¸­æ–¹æ³•åŒºçš„å­˜å‚¨çš„å†…å®¹å‘ç”Ÿäº†å¦‚ä¸‹å˜åŒ–ï¼ˆä¸Šé¢ä»‹ç»çš„æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„æ˜¯ç»å…¸æƒ…å†µä¸‹çš„ï¼Œå…·ä½“è¿˜æ˜¯éœ€è¦çœ‹ JDK æ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼‰ï¼š

| ç‰ˆæœ¬          | æè¿°                                                                                                           |
| :------------ | :------------------------------------------------------------------------------------------------------------- |
| jdk1.6 åŠä¹‹å‰ | æœ‰æ°¸ä¹…ä»£ï¼ˆpermanent generationï¼‰ï¼Œ**é™æ€å˜é‡å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸Š**                                                   |
| jdk1.7        | æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥â€œå»æ°¸ä¹…ä»£â€ï¼Œ**å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­**                                     |
| jdk1.8 åŠä¹‹å | æ— æ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€**å¸¸é‡**ä¿å­˜åœ¨**æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´**ï¼Œä½†**å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»ç„¶ä¿å­˜åœ¨å †ä¸­** |

!> ä¸Šé¢è¯´çš„é™æ€å˜é‡åœ¨ JDK1.6 ä¹‹å‰å­˜æ”¾åœ¨æ°¸ä¹…ä»£ï¼ŒJDK1.7 åç§»åŠ¨åˆ°å †ç©ºé—´æŒ‡çš„æ˜¯å˜é‡æœ¬èº«ï¼Œå˜é‡å¯¹åº”çš„å¯¹è±¡å®ä¾‹ä¸€ç›´éƒ½æ˜¯åœ¨å †ç©ºé—´åˆ†é…çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```java
public class StaticObjTest {

    static class Test {
        static ObjectHolder staticObj = new ObjectHolder();
        ObjectHolder instanceObj = new ObjectHolder();

        void foo() {
            ObjectHolder localObj = new ObjectHolder();
        }
    }

    private static class ObjectHolder {

    }
}
```

!> è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸‰ä¸ª new ObjectHolder()çš„åˆ›å»ºï¼Œéƒ½æ˜¯åœ¨å †ä¸­åˆ†é…çš„ï¼ŒlocalObj æ˜¯æ–¹æ³• foo å†…çš„å±€éƒ¨å˜é‡ï¼Œå­˜æ”¾åœ¨è™šæ‹Ÿæœºæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼›instanceObj ä¸ºæˆå‘˜å˜é‡ï¼Œéšç€å¯¹è±¡å®ä¾‹çš„åˆ›å»ºä¹Ÿåˆ†é…åœ¨å †ä¸­ï¼›é™æ€å˜é‡ staticObj æ ¹æ® JDK ç‰ˆæœ¬çš„ä¸åŒå­˜æ”¾ä½ç½®ä¹Ÿä¸åŒï¼ŒJDK1.6 åŠä¹‹å‰ï¼Œå­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸­ï¼ŒJDK1.7 åŠä¹‹åå­˜æ”¾åˆ°å †ä¸­ã€‚

æ°¸ä¹…ä»£ä¸ºä»€ä¹ˆä¼šè¢«å…ƒç©ºé—´æ›¿ä»£ï¼Ÿå› ä¸ºæ°¸ä¹…ä»£çš„å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºåŠ¨æ€åŠ è½½çš„ç±»è¿‡å¤šå°±å¾ˆå®¹æ˜“è§¦å‘æ°¸ä¹…ä»£çš„ Full GCï¼ˆFull GC ä»£ä»·å¤§ï¼Œè€—æ—¶é•¿ï¼Œå½±å“ç¨‹åºæ€§èƒ½ï¼‰ç”šè‡³ OOMï¼Œç¨‹åºç›´æ¥å¥”æºƒï¼›è€Œå…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œè¿™æ ·å…ƒç©ºé—´å°±åŸºæœ¬ä¸ä¼šå› ä¸ºè§¦å‘ Full GC å’Œ OOM äº†ã€‚

å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆStringTableï¼‰ä¸ºä»€ä¹ˆè¦æ”¾åˆ°å †ä¸­ï¼Ÿå› ä¸ºå¦‚æœå°† StringTable æ”¾åœ¨æ°¸ä¹…ä»£çš„è¯å›æ”¶æ•ˆç‡å¾ˆä½ï¼Œåœ¨ Full GC çš„æ—¶å€™æ‰ä¼šè§¦å‘ã€‚è€Œ Full GC æ˜¯è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ã€æ°¸ä¹…ä»£ä¸è¶³æ—¶æ‰ä¼šè§¦å‘ã€‚è¿™å°±å¯¼è‡´ StringTable å›æ”¶æ•ˆç‡ä¸é«˜ã€‚è€Œæˆ‘ä»¬å¼€å‘ä¸­ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²è¢«åˆ›å»ºï¼Œå›æ”¶æ•ˆç‡ä½ï¼Œå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜ä¸è¶³ã€‚æ”¾åˆ°å †é‡Œï¼Œèƒ½åŠæ—¶å›æ”¶å†…å­˜ã€‚

##### 8.5.æ–¹æ³•åŒºåƒåœ¾å›æ”¶

æ–¹æ³•åŒºä¹Ÿå­˜åœ¨åƒåœ¾å›æ”¶ï¼Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚

#### 9.æ‰§è¡Œå¼•æ“

ç±»åŠ è½½å™¨åŠ è½½çš„å­—èŠ‚ç å¹¶ä¸èƒ½å¤Ÿç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œå› ä¸ºå­—èŠ‚ç æŒ‡ä»¤ä¸æ˜¯æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œæ‰§è¡Œå¼•æ“ï¼ˆExecute Engineï¼‰çš„ä»»åŠ¡å°±æ˜¯è®²å­—èŠ‚ç æŒ‡ä»¤è§£é‡Šä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ã€‚é€šä¿—åœ°è®²ï¼Œæ‰§è¡Œå¼•æ“å°±æ˜¯å°†é«˜çº§è¯­è¨€ç¿»è¯‘ä¸ºæœ¬åœ°æœºå™¨è¯­è¨€çš„ç¿»è¯‘å®˜ã€‚

##### 9.1.è§£é‡Šå™¨å’Œ JIT ç¼–è¯‘å™¨

- è§£é‡Šå™¨ï¼ˆInterpreterï¼‰ï¼šJVM åœ¨ç¨‹åºè¿è¡Œæ—¶é€šè¿‡è§£é‡Šå™¨é€è¡Œå°†å­—èŠ‚ç è½¬ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œï¼›
- JIT ç¼–è¯‘å™¨ï¼ˆJust In Time Compilerï¼Œå³æ—¶ç¼–è¯‘å™¨ï¼‰ï¼šè§£é‡Šå™¨çš„ä¼˜ç‚¹æ˜¯ç¨‹åºä¸€å¯åŠ¨å°±å¯ä»¥é©¬ä¸Šå‘æŒ¥ä½œç”¨ï¼Œé€è¡Œç¿»è¯‘å­—èŠ‚ç æ‰§è¡Œç¨‹åºã€‚è€Œå¯¹äºä¸€äº›é«˜é¢‘çš„ä»£ç ï¼ˆå¦‚å¾ªç¯ä½“å†…ä»£ç å’Œé«˜é¢‘è°ƒç”¨æ–¹æ³•ç­‰ï¼‰ï¼Œå¦‚æœæ¯æ¬¡æ‰§è¡Œéƒ½ç”¨è§£é‡Šå™¨é€è¡Œå°†å­—èŠ‚ç ç¿»è¯‘ä¸ºæœºå™¨æŒ‡ä»¤çš„è¯ï¼ŒåŠ¿å¿…ä¼šé€ æˆæµªè´¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å³æ—¶ç¼–è¯‘å™¨å°†è¿™éƒ¨åˆ†é«˜é¢‘ä»£ç ç›´æ¥ç¼–è¯‘ä¸ºæœºå™¨æŒ‡ä»¤ç„¶åç¼“å­˜åœ¨æ–¹æ³•åŒºä¸­ï¼ˆä¸Šé¢ä»‹ç»æ–¹æ³•åŒºå†…éƒ¨ç»„æˆæ—¶æåˆ°è¿‡ JIT ä»£ç ç¼“å­˜ï¼‰ï¼Œä»¥æ­¤æé«˜æ‰§è¡Œæ•ˆç‡ã€‚å’Œè§£é‡Šå™¨ç›¸æ¯”ï¼Œå³æ—¶ç¼–è¯‘å™¨çš„ç¼ºç‚¹å°±æ˜¯ç¼–è¯‘éœ€è¦è€—è´¹ä¸€å®šæ—¶é—´ã€‚

?> æ­£å› ä¸º JVM åœ¨æ‰§è¡Œ Java ä»£ç çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šå°†è§£é‡Šæ‰§è¡Œå’Œç¼–è¯‘æ‰§è¡ŒäºŒè€…ç»“åˆèµ·æ¥è¿›è¡Œï¼Œæ‰€ä»¥ Java ä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€ã€‚

###### 9.1.1.çƒ­ç‚¹ä»£ç 

hotspot é€šè¿‡ä¸¤ç§æ–¹å¼æ¥ç¡®å®šå½“å‰ä»£ç æ˜¯å¦ä¸ºçƒ­ç‚¹ä»£ç ï¼š

- æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼šç»Ÿè®¡æ–¹æ³•è°ƒç”¨çš„æ¬¡æ•°ï¼›
- å›è¾¹è®¡æ•°å™¨ï¼šç»Ÿè®¡å¾ªç¯ä½“æ‰§è¡Œçš„å¾ªç¯æ¬¡æ•°ã€‚

å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦å­˜åœ¨è¢« JIT ç¼–è¯‘å™¨ç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ç¼–è¯‘åçš„æœ¬åœ°ä»£ç æ‰§è¡Œï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å°†æ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨åŠ  1ï¼Œç„¶ååˆ¤æ–­æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨å’Œå›è¾¹è®¡æ•°å™¨ä¹‹å’Œæ˜¯å¦è¶…è¿‡æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çš„é˜ˆå€¼ã€‚å¦‚æœè¶…è¿‡ï¼Œåˆ™ä¼šå‘ JIT ç¼–è¯‘å™¨æäº¤ä¸€ä¸ªè¯¥æ–¹æ³•çš„ä»£ç ç¼–è¯‘è¯·æ±‚ã€‚

ä¸Šé¢çš„é˜ˆå€¼å¯ä»¥ä½¿ç”¨`-XX:CompileThreshold`è®¾å®šï¼Œé»˜è®¤å€¼åœ¨ Client æ¨¡å¼ä¸‹æ˜¯ 1500ï¼Œåœ¨ Server æ¨¡å¼ä¸‹æ˜¯ 10000ã€‚

æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç»Ÿè®¡çš„å¹¶ä¸æ˜¯æ–¹æ³•è¢«è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè€Œæ˜¯åœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…çš„æ¬¡æ•°ã€‚è¶…è¿‡è¿™ä¸ªæ—¶é—´èŒƒå›´ï¼Œè¿™ä¸ªæ–¹æ³•è®¡æ•°å™¨å°±ä¼šå‡å°‘ä¸€åŠï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºçƒ­åº¦è¡°å‡ï¼Œè¿™ä¸ªæ—¶é—´å‘¨æœŸç§°ä¸ºåŠè¡°å‘¨æœŸã€‚å¯ä»¥é€šè¿‡`-XX:CounterHalfLifeTime`è®¾ç½®åŠè¡°å‘¨æœŸï¼ˆå•ä½ Sï¼‰ï¼Œ`-XX:-UseCounterDecay`æ¥å…³é—­çƒ­åº¦è¡°å‡ã€‚

##### 9.2.æ¨¡å¼è®¾ç½®

é»˜è®¤æƒ…å†µä¸‹ï¼Œhotspot é‡‡ç”¨æ··åˆæ¨¡å¼æ¶æ„ï¼ˆå³è§£é‡Šå™¨å’Œ JIT ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™äº›æŒ‡ä»¤æ¥åˆ‡æ¢æ¨¡å¼ï¼š

- `-Xint`ï¼šå®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ¨¡å¼æ‰§è¡Œç¨‹åºï¼›
- `-Xcomp`ï¼šå®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ¨¡å¼æ‰§è¡Œç¨‹åºï¼Œå¦‚æœå³æ—¶ç¼–è¯‘å™¨å‡ºç°é—®é¢˜ï¼Œè§£é‡Šå™¨ä¼šä»‹å…¥æ‰§è¡Œï¼›
- `-Xmixed`ï¼šæ··åˆæ¨¡å¼ã€‚

![](https://typora-img-1257000606.cos.ap-beijing.myqcloud.com/9H3ifA.png)

##### 9.3.JIT ç¼–è¯‘å™¨åˆ†ç±»

hotspot å†…ç½®ä¸¤ç§ JIT ç¼–è¯‘å™¨ï¼šClient Compiler å’Œ Server Compilerï¼Œä¹Ÿç§°ä¸º C1 ç¼–è¯‘å™¨å’Œ C2 ç¼–è¯‘å™¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™äº›æŒ‡ä»¤æ¥æŒ‡å®šä½¿ç”¨å“ªç§ JIT ç¼–è¯‘å™¨ï¼š

- `-client`ï¼šæŒ‡å®š Java è™šæ‹Ÿæœºè¿è¡Œåœ¨ Client æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ C1 ç¼–è¯‘å™¨ã€‚C1 ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å’Œå¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ï¼Œå·²è¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ï¼›
- `-server`ï¼šæŒ‡å®š Java è™šæ‹Ÿæœºè¿è¡Œåœ¨ Server æ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨ C2 ç¼–è¯‘å™¨ã€‚C2 ç¼–è¯‘å™¨è¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œä»¥åŠæ¿€è¿›ä¼˜åŒ–ï¼Œè™½ç„¶ç¼–è¯‘è€—æ—¶æ›´é•¿ï¼Œä½†ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼ˆ64 ä½ JDK åªæ”¯æŒ Server æ¨¡å¼ï¼‰ã€‚

> å‚è€ƒæ–‡ç« ï¼š<br> > https://mrbird.cc/JVM-Learn.html<br> > https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html<br> > https://docs.oracle.com/en/java/javase/11/tools/java.html<br> > https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html<br> > http://www.atguigu.com/download_detail.shtml?v=279
